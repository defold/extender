name: Build Docker environment container

on:
  workflow_dispatch:
  push:
    tags:
      - "android*"
      - "base*"
      - "linux*"
      - "emsdk*"
      - "wine*"
      - "winsdk*"
      - "nssdk*"
      - "ps4*"
      - "ps5*"

env:
  GOOGLE_ARTIFACT_REGISTRY: europe-west1-docker.pkg.dev
  PUBLIC_REGISTRY: europe-west1-docker.pkg.dev/extender-426409/extender-public-registry
  PRIVATE_REGISTRY_PS4: europe-west1-docker.pkg.dev/extender-426409/extender-ps4-private-registry
  PRIVATE_REGISTRY_PS5: europe-west1-docker.pkg.dev/extender-426409/extender-ps5-private-registry
  PRIVATE_REGISTRY_NINTENDO: europe-west1-docker.pkg.dev/extender-426409/extender-nintendo-private-registry
  PRIVATE_REGISTRY_XBOX: europe-west1-docker.pkg.dev/extender-426409/extender-xbox-private-registry
  PRIVATE_PLATFORMS: "nssdk ps4 ps5 xbox"

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
    - name: Process tag name
      id: name_postprocess
      run: |
          PRIVATE_PLATFORM_LIST="${{ env.PRIVATE_PLATFORMS }}"
          PUBLIC_REGISTRY="${{ env.PUBLIC_REGISTRY }}"
          PRIVATE_REGISTRY_PS4="${{ env.PRIVATE_REGISTRY_PS4 }}"
          PRIVATE_REGISTRY_PS5="${{ env.PRIVATE_REGISTRY_PS5 }}"
          PRIVATE_REGISTRY_NINTENDO="${{ env.PRIVATE_REGISTRY_NINTENDO }}"
          PRIVATE_REGISTRY_XBOX="${{ env.PRIVATE_REGISTRY_XBOX }}"

          SHORT_SHA="$(echo ${GITHUB_SHA} | cut -c1-8)"
          TAG_NAME=${{ github.ref_name }}
          DOCKERFILE="${TAG_NAME%%-*}"
          PLATFORM="${DOCKERFILE%%.*}"
          PLATFORM_VERSION=$(if [[ "$DOCKERFILE" == *"."* ]]; then echo "${DOCKERFILE#*.}"; else echo ""; fi)
          IMAGE_VERSION="${TAG_NAME#*-}"
          IMAGE_NAME=$(if [[ "$PLATFORM_VERSION" != "" ]]; then echo "$PLATFORM-$PLATFORM_VERSION"; else echo "$PLATFORM"; fi)

          if [[ $PRIVATE_PLATFORM_LIST == *$PLATFORM* ]]; then
            case $PLATFORM in
                ps4)
                  TARGET_REGISTRY=$(echo $PRIVATE_REGISTRY_PS4)
                ;;
                ps5)
                  TARGET_REGISTRY=$(echo $PRIVATE_REGISTRY_PS5)
                ;;
                nssdk)
                  TARGET_REGISTRY=$(echo $PRIVATE_REGISTRY_NINTENDO)
                ;;
                xbox)
                  TARGET_REGISTRY=$(echo $PRIVATE_REGISTRY_XBOX)
                ;;
            esac
          else 
            TARGET_REGISTRY=$(echo $PUBLIC_REGISTRY)
          fi
          
          case $PLATFORM in
            base|linux)
              BUILD_PLATFORMS="linux/amd64,linux/arm64"
            ;;
            *)
              BUILD_PLATFORMS="linux/amd64"
            ;;
          esac

          echo "TAG_NAME $TAG_NAME"
          echo "DOCKERFILE $DOCKERFILE"
          echo "PLATFORM $PLATFORM"
          echo "PLATFORM_VERSION $PLATFORM_VERSION"
          echo "IMAGE_VERSION $IMAGE_VERSION"
          echo "IMAGE_NAME $IMAGE_NAME"
          echo "TARGET_REGISTRY $TARGET_REGISTRY"
          echo "BUILD_PLATFORMS $BUILD_PLATFORMS"

          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "dockerfile=$DOCKERFILE" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "platform_version=$PLATFORM_VERSION" >> $GITHUB_OUTPUT
          echo "image_version=$IMAGE_VERSION" >> $GITHUB_OUTPUT
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "target_registry=$TARGET_REGISTRY" >> $GITHUB_OUTPUT
          echo "build_platforms=$BUILD_PLATFORMS" >> $GITHUB_OUTPUT
    - name: Login to Google Artifact registry
      uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
      with:
        registry: ${{ env.GOOGLE_ARTIFACT_REGISTRY }}
        username: _json_key
        password: ${{ secrets.DOCKER_REGISTRY_JSON_KEY }}
    - name: Set up QEMU
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
      with:
        platforms: amd64,arm64
        image: tonistiigi/binfmt:qemu-v7.0.0
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
    - name: Build and push
      env:
        DM_PACKAGES_URL:  ${{ secrets.S3_URL }}
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      with:
        context: ${{ github.workspace }}/server/docker/
        file: ${{ github.workspace }}/server/docker/Dockerfile.${{ steps.name_postprocess.outputs.dockerfile }}-env
        pull: true
        push: true
        platforms: |
          ${{ steps.name_postprocess.outputs.build_platforms }}
        secret-envs: |
          DM_PACKAGES_URL=DM_PACKAGES_URL
        tags: |
          ${{ steps.name_postprocess.outputs.target_registry }}/extender-${{ steps.name_postprocess.outputs.image_name }}-env:${{ steps.name_postprocess.outputs.image_version }}
          ${{ steps.name_postprocess.outputs.target_registry }}/extender-${{ steps.name_postprocess.outputs.image_name }}-env:${{ steps.name_postprocess.outputs.short_sha }}
          ${{ steps.name_postprocess.outputs.target_registry }}/extender-${{ steps.name_postprocess.outputs.image_name }}-env:latest

    - name: Notify if tests failed
      uses: lazy-actions/slatify@cd4b4a1158cfb3e26fe1ee35c1cd4f0247dfbf96
      if: failure()
      with:
        type: ${{ job.status }}
        job_name: 'Extender: Docker environment container'
        channel: '#defold-alarms-build'
        url: ${{ secrets.SLACK_WEBHOOK }}
